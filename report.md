## ä¸€ã€å®éªŒç›®çš„

æœ¬å®éªŒè¦æ±‚ä½ ä½¿ç”¨è¯¾ç¨‹æ‰€å­¦çŸ¥è¯†æ‹†é™¤â€œbinary bombsï¼ˆäºŒè¿›åˆ¶ç‚¸å¼¹ï¼Œä¸‹æ–‡å°†ç®€ç§°ä¸ºç‚¸å¼¹ï¼‰â€ï¼Œå¢å¼ºå¯¹ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤ºã€æ±‡ç¼–è¯­è¨€ã€è°ƒè¯•å™¨å’Œé€†å‘å·¥ç¨‹ç­‰æ–¹é¢åŸç†ä¸æŠ€èƒ½çš„æŒæ¡ã€‚ è¿™é‡Œçš„ç‚¸å¼¹æ˜¯ä¸€ä¸ªLinuxå¯æ‰§è¡Œç¨‹åºï¼ŒåŒ…å«äº†6ä¸ªé˜¶æ®µï¼ˆæˆ–å±‚æ¬¡ã€å…³å¡ï¼‰ã€‚ç‚¸å¼¹è¿è¡Œçš„æ¯ä¸ªé˜¶æ®µè¦æ±‚ä½ è¾“å…¥ä¸€ä¸ªç‰¹å®šå­—ç¬¦ä¸²ï¼Œä½ çš„è¾“å…¥ç¬¦åˆç¨‹åºé¢„æœŸçš„è¾“å…¥ï¼Œè¯¥é˜¶æ®µçš„ç‚¸å¼¹å°±è¢«æ‹†é™¤å¼•ä¿¡å³è§£é™¤äº†ï¼Œå¦åˆ™ç‚¸å¼¹â€œçˆ†ç‚¸â€æ‰“å°è¾“å‡º "BOOM!!!"ã€‚å®éªŒçš„ç›®æ ‡æ˜¯æ‹†é™¤å°½å¯èƒ½å¤šçš„ç‚¸å¼¹å…³å¡ã€‚

- é˜¶æ®µ1ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒ
- é˜¶æ®µ2ï¼šå¾ªç¯
- é˜¶æ®µ3ï¼šæ¡ä»¶/åˆ†æ”¯
- é˜¶æ®µ4ï¼šé€’å½’è°ƒç”¨å’Œæ ˆ
- é˜¶æ®µ5ï¼šæŒ‡é’ˆ
- é˜¶æ®µ6ï¼šé“¾è¡¨/æŒ‡é’ˆ/ç»“æ„

å¦å¤–è¿˜æœ‰ä¸€ä¸ªéšè—é˜¶æ®µï¼Œåªæœ‰å½“ä½ åœ¨ç¬¬4é˜¶æ®µçš„è§£åé™„åŠ ä¸€ç‰¹å®šå­—ç¬¦ä¸²åæ‰ä¼šå‡ºç°ã€‚

ä¸ºå®ŒæˆäºŒè¿›åˆ¶ç‚¸å¼¹æ‹†é™¤ä»»åŠ¡ï¼Œä½ éœ€è¦ä½¿ç”¨gdbè°ƒè¯•å™¨å’Œobjdumpæ¥åæ±‡ç¼–ç‚¸å¼¹çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶è·Ÿè¸ªè°ƒè¯•æ¯ä¸€é˜¶æ®µçš„æœºå™¨ä»£ç ï¼Œä»ä¸­ç†è§£æ¯ä¸€æ±‡
ç¼–è¯­è¨€ä»£ç çš„è¡Œä¸ºæˆ–ä½œç”¨ï¼Œè¿›è€Œè®¾æ³•æ¨æ–­æ‹†é™¤ç‚¸å¼¹æ‰€éœ€çš„ç›®æ ‡å­—ç¬¦ä¸²ã€‚æ¯”å¦‚åœ¨æ¯ä¸€é˜¶æ®µçš„å¼€å§‹ä»£ç å‰å’Œå¼•çˆ†ç‚¸å¼¹çš„å‡½æ•°å‰è®¾ç½®æ–­ç‚¹ã€‚

æœ¬å®éªŒçš„ä»»åŠ¡å°±æ˜¯æ‹†é™¤ç‚¸å¼¹ã€‚ä¸€å®šè¦åœ¨æŒ‡å®šçš„è™šæ‹Ÿæœºä¸Šå®Œæˆä½œä¸šï¼Œåœ¨å…¶ä»–çš„ç¯å¢ƒä¸Šè¿è¡Œæœ‰å¯èƒ½å¯¼è‡´å¤±è´¥ã€‚ï¼ˆé‚£å§‘ä¸”å…ˆè¯•è¯•å’±çš„ Fedora Linux 36ï¼Œè‡³å°‘ï¼Œåœ¨ Fedora 36 å’Œ Windows 10 ä¸‹çš„åæ±‡ç¼–ä»£ç æ˜¯ä¸€è‡´çš„ã€‚ï¼‰

è¦å­¦ä¼šå•æ­¥è·Ÿè¸ªè°ƒè¯•æ±‡ç¼–ä»£ç ä»¥åŠå­¦ä¼šè®¾ç½®æ–­ç‚¹ã€‚ä½ è¿˜è¦å­¦ä¼šå¦‚ä½•æ£€æŸ¥å¯„å­˜å™¨å’Œå†…å­˜çŠ¶æ€ã€‚å¾ˆå¥½çš„ä½¿ç”¨è°ƒè¯•å™¨æ˜¯ä½ åœ¨æœªæ¥çš„èŒä¸šç”Ÿæ¶¯ä¸­èµšåˆ°æ›´å¤šmoneyçš„ä¸€é¡¹é‡è¦æŠ€èƒ½ï¼

## äºŒã€æŠ¥å‘Šè¦æ±‚

æœ¬æŠ¥å‘Šè¦æ±‚å­¦ç”ŸæŠŠå®éªŒä¸­å®ç°çš„æ‰€æœ‰å‡½æ•°é€ä¸€è¿›è¡Œåˆ†æè¯´æ˜ï¼Œå†™å‡ºå®ç°çš„ä¾æ®ï¼Œä¹Ÿå°±æ˜¯æ¨ç†è¿‡ç¨‹ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„æ•°å­¦è¯æ˜ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£ç åˆ†æï¼Œæ ¹æ®å®ç°ä¸­ä½ çš„æƒ³æ³•ä¸åŒè€Œå¼‚ã€‚

## ä¸‰ã€åˆ†æ

### åæ±‡ç¼–

```bash
objdump -d bomb > bomb_disas.txt
```

### phase_1 ğŸš§

#### æ­»ç£•ä»£ç 

ä¼ é€’çš„å‚æ•°æ˜¯

```C
char *input;
```

é¦–å…ˆçœ‹åœ¨`main`ä¸­è°ƒç”¨å…¶çš„éƒ¨åˆ†ï¼š

```assembly
  400d6a:	bf 48 23 40 00       	mov    $0x402348,%edi
  400d6f:	e8 6c fd ff ff       	call   400ae0 <puts@plt>
  400d74:	e8 2f 07 00 00       	call   4014a8 <read_line>
  400d79:	48 89 c7             	mov    %rax,%rdi # %rdi å­˜ *input
  400d7c:	e8 ec 00 00 00       	call   400e6d <phase_1>
  400d81:	e8 50 08 00 00       	call   4015d6 <phase_defused>
```

`phase_1`å‡½æ•°æœ¬ä½“ï¼š

```assembly
0000000000400e6d <phase_1>:
  400e6d:	48 83 ec 08          	sub    $0x8,%rsp
  400e71:	be d0 23 40 00       	mov    $0x4023d0,%esi # åæ¥ä¸€ç›´ç”¨ %rsiï¼Œ%rsi ç›¸å½“äº64ä½æ‰©å®¹å§ã€‚
  400e76:	e8 cf 04 00 00       	call   40134a <strings_not_equal>

  400e7b:	85 c0                	test   %eax,%eax # ANDä¸º0ï¼ŒZFç½®1ï¼Œå¦åˆ™ç½®0ã€‚
  400e7d:	75 05                	jne    400e84 <phase_1+0x17> # ZF=0ï¼Œè·³è½¬ï¼Œçˆ†ã€‚
  400e7f:	48 83 c4 08          	add    $0x8,%rsp # %eax ä¸º0ï¼ŒZF=1ï¼ŒOKã€‚
  400e83:	c3                   	ret

  400e84:	e8 be 05 00 00       	call   401447 <explode_bomb>
  400e89:	eb f4                	jmp    400e7f <phase_1+0x12>
```

1 Byte = 8 bit

1 ä½ Hex = 4 bit

1 Word = 32/64 bit

å½“`%eax`é 0 æ—¶ä¼šè·³è½¬åˆ°`call   401447 <explode_bomb>`ï¼Œç‚¸äº†ï¼›

éœ€è¦ç»•è¿‡å»ï¼Œä¹Ÿå°±æ˜¯æƒ³æ³•è®©`%eax`ä¸º 0ï¼Œè¿™æ ·ä¹‹åç›´æ¥`ret`ã€‚

ä¹Ÿå°±è¯¥è®© `<strings_not_equal>`è¿”å› 0ï¼Œä¹Ÿå°±å¾—è®©`40136e:	89 d0                	mov    %edx,%eax`ä¸­çš„`%edx`ä¸º 0ã€‚

å…¶è°ƒç”¨çš„`strings_not_equal`ï¼š

```assembly
000000000040134a <strings_not_equal>:
  40134a:	41 54                	push   %r12
  40134c:	55                   	push   %rbp
  40134d:	53                   	push   %rbx
  
  # ç¬¬ä¸€æ¬¡<string_length>
  40134e:	48 89 fb             	mov    %rdi,%rbx # æ¥è‡ª <main> ä¸­çš„ %rdi
  401351:	48 89 f5             	mov    %rsi,%rbp # æ¥è‡ª <phase_1> ä¸­çš„ %esi
  401354:	e8 d4 ff ff ff       	call   40132d <string_length>
  # ç¬¬äºŒæ¬¡<string_length>
  401359:	41 89 c4             	mov    %eax,%r12d # æš‚å­˜ç¬¬ä¸€é <string_length> çš„è¿”å›å€¼
  40135c:	48 89 ef             	mov    %rbp,%rdi # æ‹¿ %rsi æ¥æ›¿ï¼Œå†è°ƒä¸€éã€‚
  40135f:	e8 c9 ff ff ff       	call   40132d <string_length>
  
  401364:	ba 01 00 00 00       	mov    $0x1,%edx # %edx è®¾ä¸º 1ã€‚
  401369:	41 39 c4             	cmp    %eax,%r12d # ä¸¤æ¬¡è°ƒç”¨è¿”å›å€¼ç›¸ç­‰ï¼Œåˆ™ZFç½®1ï¼Œè¿›å¾ªç¯ã€‚
  40136c:	74 07                	je     401375 <strings_not_equal+0x2b>
  
  40136e:	89 d0                	mov    %edx,%eax # è¿”å›å€¼ä¸ç›¸ç­‰ï¼Œé‚£å°±æ˜¯è¿”å›1äº†ï¼Œçˆ†ï¼›æˆ–è€…æ˜¯ä¸‹é¢çš„å¾ªç¯ç»ˆæ­¢ã€‚
  401370:	5b                   	pop    %rbx
  401371:	5d                   	pop    %rbp
  401372:	41 5c                	pop    %r12
  401374:	c3                   	ret
  
####
#### è¿™æ®µåƒä¸ªå¾ªç¯ã€‚
  401375:	0f b6 03             	movzbl (%rbx),%eax
  401378:	84 c0                	test   %al,%al
  40137a:	74 27                	je     4013a3 <strings_not_equal+0x59> # %a1ä¸º0ï¼ŒOKã€‚

  40137c:	3a 45 00             	cmp    0x0(%rbp),%al # %a1 é0ï¼Œæ¯”è¾ƒ
  40137f:	75 29                	jne    4013aa <strings_not_equal+0x60> # ä¸ç­‰ï¼Œå®Œè›‹
  401381:	48 83 c3 01          	add    $0x1,%rbx # æ¥è‡ª <main> ä¸­çš„ %rdi + 1
  401385:	48 83 c5 01          	add    $0x1,%rbp # æ¥è‡ª <phase_1> ä¸­çš„ %esi +1
  401389:	0f b6 03             	movzbl (%rbx),%eax # è¿”å› %rbx
  
  40138c:	84 c0                	test   %al,%al # %a1 ä¸º0ï¼ŒZFç½®1ã€‚
  40138e:	74 0c                	je     40139c <strings_not_equal+0x52> # è·³è½¬ï¼Œè¿”å› 0ï¼ŒOKã€‚
  
  401390:	38 45 00             	cmp    %al,0x0(%rbp)
  401393:	74 ec                	je     401381 <strings_not_equal+0x37> # ç›¸ç­‰ï¼Œé›·åŒã€‚
  401395:	ba 01 00 00 00       	mov    $0x1,%edx # %a1!=%rbpï¼Œå®Œè›‹ã€‚
  40139a:	eb d2                	jmp    40136e <strings_not_equal+0x24> # å¼ºåˆ¶æˆªèƒ¡ã€‚
####
####

  40139c:	ba 00 00 00 00       	mov    $0x0,%edx # è¿”å› 0ï¼ŒOKã€‚
  4013a1:	eb cb                	jmp    40136e <strings_not_equal+0x24>
  
  4013a3:	ba 00 00 00 00       	mov    $0x0,%edx # OKã€‚
  4013a8:	eb c4                	jmp    40136e <strings_not_equal+0x24>
  
  4013aa:	ba 01 00 00 00       	mov    $0x1,%edx # å®Œè›‹ã€‚
  4013af:	eb bd                	jmp    40136e <strings_not_equal+0x24>
```

åˆè°ƒç”¨çš„`string_length`ï¼š

```assembly
000000000040132d <string_length>:
  40132d:	80 3f 00             	cmpb   $0x0,(%rdi) # %rdi == 0ï¼ŒZFç½®1ï¼Œåä¹‹ç½®0ã€‚
  401330:	74 12                	je     401344 <string_length+0x17> # ZF=1ï¼Œè·³è½¬ï¼Œå°† %eax ç½®0ã€‚
  401332:	48 89 fa             	mov    %rdi,%rdx # %rdx
  
  401335:	48 83 c2 01          	add    $0x1,%rdx # %rdx ++
  401339:	89 d0                	mov    %edx,%eax # %eax <- %edxï¼ˆ%rdx æˆªåŠï¼‰
  40133b:	29 f8                	sub    %edi,%eax # %eax -= %ediï¼ˆ%rdi æˆªåŠï¼‰
  
  40133d:	80 3a 00             	cmpb   $0x0,(%rdx)
  401340:	75 f3                	jne    401335 <string_length+0x8> # %rdx != 0ï¼Œå†è¿›è¡Œå‰é¢çš„å¾ªç¯
  401342:	f3 c3                	repz ret # %rdx == 0ï¼Œè¿”å›
  
  401344:	b8 00 00 00 00       	mov    $0x0,%eax
  401349:	c3                   	ret   
```

æ®æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ¤æ–­å…¶æ˜¯å¦ä¸ºç©ºï¼Œ`%rdi`ä¸º 0ï¼ˆç›¸å½“äºæ•°ç»„é¦–ä½ï¼‰çš„è¯å°±æ˜¯ä¸º`NULL`äº†å§ã€‚

ä»è¿™é‡Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä»€ä¹ˆå‰é¢çš„å¾ªç¯éƒ½æ˜¯ ++ å³å¯äº†ï¼Œ`char`æ¯•ç«Ÿæ˜¯åªå äº†1 Byteçš„ï¼Œæˆ‘ä»¬åœ¨éå†æ•°ç»„ä¸­çš„ input[0], input[1] ... æ—¶ï¼Œå½¼æ­¤ä¹‹é—´çš„åœ°å€åªå·®äº† 1ã€‚

å¥½å§ï¼Œå…¶å®æ²¡å¿…è¦å…¨éƒ¨æŠŠä»£ç ææ‡‚çš„â€¦â€¦å®é™…ä¸Šå‰é¢ç†è§£å¤§æ¦‚ä¹Ÿä¸æ€ä¹ˆåˆ°ä½ï¼Œä¹‹åå†ä¿®æ”¹å§ã€‚

#### Objdumpå¦™ç”¨

å‰é¢ç¢ç£¨äº†å¾ˆä¹…ï¼Œä¹Ÿæ²¡æœ‰æƒ³æ˜ç™½`%rsi`é‡Œåˆ°åº•å­˜äº†ä»€ä¹ˆã€‚åæ¥å‘ç°ä¼¼ä¹å€˜è‹¥åªåæ±‡ç¼–â€œexecutable sectionsâ€ï¼Œæ˜¯æ‰¾ä¸åˆ°`$0x4023d0`è¿™ä¸ªåœ°å€çš„ã€‚

å–å·§ä¸€ç‚¹ï¼š

```Bash
  -d, --disassemble        Display assembler contents of executable sections
  -D, --disassemble-all    Display assembler contents of all sections
```

```bash
objdump -D bomb > bomb_disas_all.txt
```

è€ƒè™‘åˆ°`string`åº”ä»¥`NULL`ä¸ºç•Œï¼Œåˆ™ç›´æ¥å¼€è¯»ç›´åˆ°`00`ã€‚

```assembly
  4023cf:	00 53 6c             	add    %dl,0x6c(%rbx)
  4023d2:	61                   	(bad)  
  4023d3:	76 65                	jbe    40243a <_IO_stdin_used+0x1ba>
  4023d5:	2c 20                	sub    $0x20,%al
  4023d7:	74 68                	je     402441 <_IO_stdin_used+0x1c1>
  4023d9:	6f                   	outsl  %ds:(%rsi),(%dx)
  4023da:	75 20                	jne    4023fc <_IO_stdin_used+0x17c>
  4023dc:	68 61 73 74 20       	push   $0x20747361
  4023e1:	73 6c                	jae    40244f <_IO_stdin_used+0x1cf>
  4023e3:	61                   	(bad)  
  4023e4:	69 6e 20 6d 65 2e 20 	imul   $0x202e656d,0x20(%rsi),%ebp
  4023eb:	56                   	push   %rsi
  4023ec:	69 6c 6c 61 69 6e 2c 	imul   $0x202c6e69,0x61(%rsp,%rbp,2),%ebp
  4023f3:	20 
  4023f4:	74 61                	je     402457 <_IO_stdin_used+0x1d7>
  4023f6:	6b 65 20 6d          	imul   $0x6d,0x20(%rbp),%esp
  4023fa:	79 20                	jns    40241c <_IO_stdin_used+0x19c>
  4023fc:	70 75                	jo     402473 <_IO_stdin_used+0x1f3>
  4023fe:	72 73                	jb     402473 <_IO_stdin_used+0x1f3>
  402400:	65 2e 00 00          	gs add %al,%gs:(%rax)
```

æ•´ç‚¹å­ Python ä»£ç ç®€åŒ–æ“ä½œï¼š

```Python
# Given hex values, convert them to their ASCII characters
hex_values = "53 6c 61 76 65 2c 20 74 68 6f 75 20 68 61 73 74 20 73 6c 61 69 6e 20 6d 65 2e 20 56 69 6c 6c 61 69 6e 2c 20 74 61 6b 65 20 6d 79 20 70 75 72 73 65 2e 00"
ascii_string = bytes.fromhex(hex_values).decode('ascii').rstrip('\x00')  # Remove the null terminator at the end for display
ascii_string
```

æŸ¥äº†ä¸‹ï¼Œå‡ºè‡ªã€Šæå°”ç‹ã€‹ï¼š

```c
'Slave, thou hast slain me. Villain, take my purse.'
```

æˆ‘è¯´æ€ä¹ˆå®éªŒæ–‡æ¡£é‡Œç»™çš„ç¤ºä¾‹ä¸æˆ‘ç”Ÿæˆçš„åæ±‡ç¼–ä»£ç ä¸ä¸€æ ·å‘¢ï¼ŒåŸæ¥â€¦â€¦

## å››ã€å®éªŒæ€»ç»“

### x86ä¸­çš„32ä½å’Œ64ä½å¯„å­˜å™¨

Yes, of course. It is the same register, no matter if you address it using 8/16/32/64 bit mode.

https://stackoverflow.com/questions/43623012/do-32-and-64-bit-values-share-the-same-register-space

```assembly
|63..32|31..16|15-8|7-0|
               |AH.|AL.|
               |AX.....|
       |EAX............|
|RAX...................|
```

https://stackoverflow.com/questions/228200/why-is-there-not-a-register-that-contains-the-higher-bytes-of-eax/228367#228367

https://stackoverflow.com/questions/11177137/why-do-x86-64-instructions-on-32-bit-registers-zero-the-upper-part-of-the-full-6

### `rep ret`

https://stackoverflow.com/questions/20526361/what-does-rep-ret-mean

### C String

https://stackoverflow.com/questions/6282198/reading-string-from-input-with-space-character

https://stackoverflow.com/questions/1247989/how-do-you-allow-spaces-to-be-entered-using-scanf

### C Char

**å¤§å—éœ‡æ’¼**

In C, the type of a character *constant* like `'a'` is actually an `int`, with size of 4 (or some other implementation-dependent value). In C++, the type is `char`, with size of 1. This is one of many small differences between the two languages.

https://stackoverflow.com/questions/2172943/why-is-the-size-of-a-character-sizeofa-different-in-c-and-c

In C++, `sizeof('a') == sizeof(char) == 1`. This makes intuitive sense, since `'a'` is a character literal, and `sizeof(char) == 1` as defined by the standard.

In C however, `sizeof('a') == sizeof(int)`. That is, it  appears that C character literals are actually integers. Does anyone  know why? I can find plenty of mentions of this C quirk but no  explanation for why it exists.

https://stackoverflow.com/questions/433895/why-are-c-character-literals-ints-instead-of-chars

### Byte & Word Addressing

https://stackoverflow.com/questions/48129466/why-do-we-use-byte-addressing-instead-of-word-addressing
